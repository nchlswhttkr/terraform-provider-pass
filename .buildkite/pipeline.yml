env:
  # https://buildkite.com/docs/agent/v3/configuration#git-fetch-flags
  BUILDKITE_GIT_FETCH_FLAGS: -v --prune --tags

steps:
  - label: ":golang: Check code formatting"
    command:
      - gofmt -l .
      - test -z $(gofmt -l .)
    plugins:
      - docker-compose#v3.10.0:
          run: ci
          config: .buildkite/docker-compose.yml

  - wait

  - group: ":golang: Build binaries"
    steps:
      - label: ":golang: Build {{matrix.os}} {{matrix.arch}} binary"
        command:
          - make build
          - mv terraform-provider-pass terraform-provider-pass_{{matrix.os}}_{{matrix.arch}}
        env:
          GOOS: "{{matrix.os}}"
          GOARCH: "{{matrix.arch}}"
        artifact_paths:
          - terraform-provider-pass*
        plugins:
          - docker-compose#v3.10.0:
              run: ci
              config: .buildkite/docker-compose.yml
              env:
                - GOOS
                - GOARCH
        matrix:
          setup:
            os:
              - darwin
              - linux
            arch:
              - amd64
              - arm64

  - label: ":terraform: Generate plugin documentation"
    command: make docs
    artifact_paths:
      - docs/**/*
    plugins:
      - docker-compose#v3.10.0:
          run: ci
          config: .buildkite/docker-compose.yml
